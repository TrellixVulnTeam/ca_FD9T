import { from, of, iif, throwError } from 'rxjs';
import { Injectable } from '@angular/core';
import { isHttpInterceptorRouteConfig, AuthClientConfig, } from './auth.config';
import { switchMap, first, concatMap, pluck, catchError } from 'rxjs/operators';
import { AuthService } from './auth.service';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './auth.config';
import * as ɵngcc2 from './auth.service';
export class AuthHttpInterceptor {
    constructor(configFactory, authService) {
        this.configFactory = configFactory;
        this.authService = authService;
    }
    intercept(req, next) {
        var _a;
        const config = this.configFactory.get();
        if (!((_a = config.httpInterceptor) === null || _a === void 0 ? void 0 : _a.allowedList)) {
            return next.handle(req);
        }
        return this.findMatchingRoute(req, config.httpInterceptor).pipe(concatMap((route) => iif(
        // Check if a route was matched
        () => route !== null, 
        // If we have a matching route, call getTokenSilently and attach the token to the
        // outgoing request
        of(route).pipe(pluck('tokenOptions'), concatMap((options) => this.authService.getAccessTokenSilently(options).pipe(catchError((err) => {
            if (this.allowAnonymous(route, err)) {
                return of('');
            }
            return throwError(err);
        }))), switchMap((token) => {
            // Clone the request and attach the bearer token
            const clone = token
                ? req.clone({
                    headers: req.headers.set('Authorization', `Bearer ${token}`),
                })
                : req;
            return next.handle(clone);
        })), 
        // If the URI being called was not found in our httpInterceptor config, simply
        // pass the request through without attaching a token
        next.handle(req))));
    }
    /**
     * Strips the query and fragment from the given uri
     * @param uri The uri to remove the query and fragment from
     */
    stripQueryFrom(uri) {
        if (uri.indexOf('?') > -1) {
            uri = uri.substr(0, uri.indexOf('?'));
        }
        if (uri.indexOf('#') > -1) {
            uri = uri.substr(0, uri.indexOf('#'));
        }
        return uri;
    }
    /**
     * Determines whether the specified route can have an access token attached to it, based on matching the HTTP request against
     * the interceptor route configuration.
     * @param route The route to test
     * @param request The HTTP request
     */
    canAttachToken(route, request) {
        const testPrimitive = (value) => {
            if (!value) {
                return false;
            }
            const requestPath = this.stripQueryFrom(request.url);
            if (value === requestPath) {
                return true;
            }
            // If the URL ends with an asterisk, match using startsWith.
            return (value.indexOf('*') === value.length - 1 &&
                request.url.startsWith(value.substr(0, value.length - 1)));
        };
        if (isHttpInterceptorRouteConfig(route)) {
            if (route.httpMethod && route.httpMethod !== request.method) {
                return false;
            }
            /* istanbul ignore if */
            if (!route.uri && !route.uriMatcher) {
                console.warn('Either a uri or uriMatcher is required when configuring the HTTP interceptor.');
            }
            return route.uriMatcher
                ? route.uriMatcher(request.url)
                : testPrimitive(route.uri);
        }
        return testPrimitive(route);
    }
    /**
     * Tries to match a route from the SDK configuration to the HTTP request.
     * If a match is found, the route configuration is returned.
     * @param request The Http request
     * @param config HttpInterceptorConfig
     */
    findMatchingRoute(request, config) {
        return from(config.allowedList).pipe(first((route) => this.canAttachToken(route, request), null));
    }
    allowAnonymous(route, err) {
        return (!!route &&
            isHttpInterceptorRouteConfig(route) &&
            !!route.allowAnonymous &&
            ['login_required', 'consent_required'].includes(err.error));
    }
}
AuthHttpInterceptor.ɵfac = function AuthHttpInterceptor_Factory(t) { return new (t || AuthHttpInterceptor)(ɵngcc0.ɵɵinject(ɵngcc1.AuthClientConfig), ɵngcc0.ɵɵinject(ɵngcc2.AuthService)); };
AuthHttpInterceptor.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: AuthHttpInterceptor, factory: AuthHttpInterceptor.ɵfac });
AuthHttpInterceptor.ctorParameters = () => [
    { type: AuthClientConfig },
    { type: AuthService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(AuthHttpInterceptor, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.AuthClientConfig }, { type: ɵngcc2.AuthService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5pbnRlcmNlcHRvci5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vcHJvamVjdHMvYXV0aDAtYW5ndWxhci9zcmMvbGliL2F1dGguaW50ZXJjZXB0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBT0EsT0FBTyxFQUFjLElBQUksRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM3RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFFTCw0QkFBNEIsRUFDNUIsZ0JBQWdCLEdBRWpCLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDaEYsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7O0FBSTdDLE1BQU0sT0FBTyxtQkFBbUI7QUFBRyxJQUNqQyxZQUNVLGFBQStCLEVBQy9CLFdBQXdCO0FBQ2pDLFFBRlMsa0JBQWEsR0FBYixhQUFhLENBQWtCO0FBQUMsUUFDaEMsZ0JBQVcsR0FBWCxXQUFXLENBQWE7QUFDcEMsSUFBSyxDQUFDO0FBQ04sSUFDRSxTQUFTLENBQ1AsR0FBcUIsRUFDckIsSUFBaUI7QUFDbEI7QUFBZ0IsUUFDZixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBQzVDLFFBQUksSUFBSSxRQUFDLE1BQU0sQ0FBQyxlQUFlLDBDQUFFLFdBQVcsQ0FBQSxFQUFFO0FBQzlDLFlBQU0sT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzlCLFNBQUs7QUFDTCxRQUNJLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsSUFBSSxDQUM3RCxTQUFTLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUNsQixHQUFHO0FBQ1gsUUFBVSwrQkFBK0I7QUFDekMsUUFBVSxHQUFHLEVBQUUsQ0FBQyxLQUFLLEtBQUssSUFBSTtBQUM3QixRQUFTLGlGQUFpRjtBQUMzRixRQUFVLG1CQUFtQjtBQUM3QixRQUFVLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQ1osS0FBSyxDQUFDLGNBQWMsQ0FBQyxFQUNyQixTQUFTLENBQThDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FDakUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQ25ELFVBQVUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO0FBQ25DLFlBQWtCLElBQUksSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLEVBQUU7QUFDdkQsZ0JBQW9CLE9BQU8sRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ2xDLGFBQW1CO0FBQ25CLFlBQ2tCLE9BQU8sVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3pDLFFBQWdCLENBQUMsQ0FBQyxDQUNILENBQ0YsRUFDRCxTQUFTLENBQUMsQ0FBQyxLQUFhLEVBQUUsRUFBRTtBQUN4QyxZQUFjLGdEQUFnRDtBQUM5RCxZQUFjLE1BQU0sS0FBSyxHQUFHLEtBQUs7QUFDakMsZ0JBQWdCLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDO0FBQzVCLG9CQUFvQixPQUFPLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQ3RCLGVBQWUsRUFDZixVQUFVLEtBQUssRUFBRSxDQUNsQjtBQUNyQixpQkFBbUIsQ0FBQztBQUNwQixnQkFBZ0IsQ0FBQyxDQUFDLEdBQUcsQ0FBQztBQUN0QixZQUNjLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN4QyxRQUFZLENBQUMsQ0FBQyxDQUNIO0FBQ1YsUUFBUyw4RUFBOEU7QUFDeEYsUUFBVSxxREFBcUQ7QUFDL0QsUUFBVSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUNqQixDQUNGLENBQ0YsQ0FBQztBQUNOLElBQUUsQ0FBQztBQUNILElBQ0U7QUFDRjtBQUNFO0FBQ0UsT0FBQztBQUNMLElBQVUsY0FBYyxDQUFDLEdBQVc7QUFBSSxRQUNwQyxJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7QUFDL0IsWUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQzVDLFNBQUs7QUFDTCxRQUNJLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRTtBQUMvQixZQUFNLEdBQUcsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDNUMsU0FBSztBQUNMLFFBQ0ksT0FBTyxHQUFHLENBQUM7QUFDZixJQUFFLENBQUM7QUFDSCxJQUNFO0FBQ0Y7QUFDRTtBQUNFO0FBQ0U7QUFFSixPQURHO0FBQ0wsSUFBVSxjQUFjLENBQ3BCLEtBQXlCLEVBQ3pCLE9BQXlCO0FBQzFCLFFBQ0MsTUFBTSxhQUFhLEdBQUcsQ0FBQyxLQUF5QixFQUFXLEVBQUU7QUFDakUsWUFBTSxJQUFJLENBQUMsS0FBSyxFQUFFO0FBQ2xCLGdCQUFRLE9BQU8sS0FBSyxDQUFDO0FBQ3JCLGFBQU87QUFDUCxZQUNNLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzNELFlBQ00sSUFBSSxLQUFLLEtBQUssV0FBVyxFQUFFO0FBQ2pDLGdCQUFRLE9BQU8sSUFBSSxDQUFDO0FBQ3BCLGFBQU87QUFDUCxZQUNNLDREQUE0RDtBQUNsRSxZQUFNLE9BQU8sQ0FDTCxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQztBQUMvQyxnQkFBUSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQzFELENBQUM7QUFDUixRQUFJLENBQUMsQ0FBQztBQUNOLFFBQ0ksSUFBSSw0QkFBNEIsQ0FBQyxLQUFLLENBQUMsRUFBRTtBQUM3QyxZQUFNLElBQUksS0FBSyxDQUFDLFVBQVUsSUFBSSxLQUFLLENBQUMsVUFBVSxLQUFLLE9BQU8sQ0FBQyxNQUFNLEVBQUU7QUFDbkUsZ0JBQVEsT0FBTyxLQUFLLENBQUM7QUFDckIsYUFBTztBQUNQLFlBQ00sd0JBQXdCO0FBQzlCLFlBQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFO0FBQzNDLGdCQUFRLE9BQU8sQ0FBQyxJQUFJLENBQ1YsK0VBQStFLENBQ2hGLENBQUM7QUFDVixhQUFPO0FBQ1AsWUFDTSxPQUFPLEtBQUssQ0FBQyxVQUFVO0FBQzdCLGdCQUFRLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUM7QUFDdkMsZ0JBQVEsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDbkMsU0FBSztBQUNMLFFBQ0ksT0FBTyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDaEMsSUFBRSxDQUFDO0FBQ0gsSUFDRTtBQUNGO0FBQ0U7QUFDRTtBQUNFO0FBRUosT0FERztBQUNMLElBQVUsaUJBQWlCLENBQ3ZCLE9BQXlCLEVBQ3pCLE1BQTZCO0FBQzlCLFFBQ0MsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FDbEMsS0FBSyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FDNUQsQ0FBQztBQUNOLElBQUUsQ0FBQztBQUNILElBQ1UsY0FBYyxDQUFDLEtBQWdDLEVBQUUsR0FBUTtBQUFJLFFBQ25FLE9BQU8sQ0FDTCxDQUFDLENBQUMsS0FBSztBQUNiLFlBQU0sNEJBQTRCLENBQUMsS0FBSyxDQUFDO0FBQ3pDLFlBQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQyxjQUFjO0FBQzVCLFlBQU0sQ0FBQyxnQkFBZ0IsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQzNELENBQUM7QUFDTixJQUFFLENBQUM7QUFDSDsrQ0FqSkMsVUFBVTt5SEFDVDtBQUFDO0FBQTZDLFlBVDlDLGdCQUFnQjtBQUNoQixZQUlPLFdBQVc7QUFBRzs7OytHQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBIdHRwSW50ZXJjZXB0b3IsXG4gIEh0dHBSZXF1ZXN0LFxuICBIdHRwSGFuZGxlcixcbiAgSHR0cEV2ZW50LFxufSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5cbmltcG9ydCB7IE9ic2VydmFibGUsIGZyb20sIG9mLCBpaWYsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHtcbiAgQXBpUm91dGVEZWZpbml0aW9uLFxuICBpc0h0dHBJbnRlcmNlcHRvclJvdXRlQ29uZmlnLFxuICBBdXRoQ2xpZW50Q29uZmlnLFxuICBIdHRwSW50ZXJjZXB0b3JDb25maWcsXG59IGZyb20gJy4vYXV0aC5jb25maWcnO1xuXG5pbXBvcnQgeyBzd2l0Y2hNYXAsIGZpcnN0LCBjb25jYXRNYXAsIHBsdWNrLCBjYXRjaEVycm9yIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQXV0aFNlcnZpY2UgfSBmcm9tICcuL2F1dGguc2VydmljZSc7XG5pbXBvcnQgeyBHZXRUb2tlblNpbGVudGx5T3B0aW9ucyB9IGZyb20gJ0BhdXRoMC9hdXRoMC1zcGEtanMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQXV0aEh0dHBJbnRlcmNlcHRvciBpbXBsZW1lbnRzIEh0dHBJbnRlcmNlcHRvciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY29uZmlnRmFjdG9yeTogQXV0aENsaWVudENvbmZpZyxcbiAgICBwcml2YXRlIGF1dGhTZXJ2aWNlOiBBdXRoU2VydmljZVxuICApIHt9XG5cbiAgaW50ZXJjZXB0KFxuICAgIHJlcTogSHR0cFJlcXVlc3Q8YW55PixcbiAgICBuZXh0OiBIdHRwSGFuZGxlclxuICApOiBPYnNlcnZhYmxlPEh0dHBFdmVudDxhbnk+PiB7XG4gICAgY29uc3QgY29uZmlnID0gdGhpcy5jb25maWdGYWN0b3J5LmdldCgpO1xuICAgIGlmICghY29uZmlnLmh0dHBJbnRlcmNlcHRvcj8uYWxsb3dlZExpc3QpIHtcbiAgICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXEpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmZpbmRNYXRjaGluZ1JvdXRlKHJlcSwgY29uZmlnLmh0dHBJbnRlcmNlcHRvcikucGlwZShcbiAgICAgIGNvbmNhdE1hcCgocm91dGUpID0+XG4gICAgICAgIGlpZihcbiAgICAgICAgICAvLyBDaGVjayBpZiBhIHJvdXRlIHdhcyBtYXRjaGVkXG4gICAgICAgICAgKCkgPT4gcm91dGUgIT09IG51bGwsXG4gICAgICAgICAgLy8gSWYgd2UgaGF2ZSBhIG1hdGNoaW5nIHJvdXRlLCBjYWxsIGdldFRva2VuU2lsZW50bHkgYW5kIGF0dGFjaCB0aGUgdG9rZW4gdG8gdGhlXG4gICAgICAgICAgLy8gb3V0Z29pbmcgcmVxdWVzdFxuICAgICAgICAgIG9mKHJvdXRlKS5waXBlKFxuICAgICAgICAgICAgcGx1Y2soJ3Rva2VuT3B0aW9ucycpLFxuICAgICAgICAgICAgY29uY2F0TWFwPEdldFRva2VuU2lsZW50bHlPcHRpb25zLCBPYnNlcnZhYmxlPHN0cmluZz4+KChvcHRpb25zKSA9PlxuICAgICAgICAgICAgICB0aGlzLmF1dGhTZXJ2aWNlLmdldEFjY2Vzc1Rva2VuU2lsZW50bHkob3B0aW9ucykucGlwZShcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmFsbG93QW5vbnltb3VzKHJvdXRlLCBlcnIpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBvZignJyk7XG4gICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycik7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIHN3aXRjaE1hcCgodG9rZW46IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAvLyBDbG9uZSB0aGUgcmVxdWVzdCBhbmQgYXR0YWNoIHRoZSBiZWFyZXIgdG9rZW5cbiAgICAgICAgICAgICAgY29uc3QgY2xvbmUgPSB0b2tlblxuICAgICAgICAgICAgICAgID8gcmVxLmNsb25lKHtcbiAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogcmVxLmhlYWRlcnMuc2V0KFxuICAgICAgICAgICAgICAgICAgICAgICdBdXRob3JpemF0aW9uJyxcbiAgICAgICAgICAgICAgICAgICAgICBgQmVhcmVyICR7dG9rZW59YFxuICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICA6IHJlcTtcblxuICAgICAgICAgICAgICByZXR1cm4gbmV4dC5oYW5kbGUoY2xvbmUpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICApLFxuICAgICAgICAgIC8vIElmIHRoZSBVUkkgYmVpbmcgY2FsbGVkIHdhcyBub3QgZm91bmQgaW4gb3VyIGh0dHBJbnRlcmNlcHRvciBjb25maWcsIHNpbXBseVxuICAgICAgICAgIC8vIHBhc3MgdGhlIHJlcXVlc3QgdGhyb3VnaCB3aXRob3V0IGF0dGFjaGluZyBhIHRva2VuXG4gICAgICAgICAgbmV4dC5oYW5kbGUocmVxKVxuICAgICAgICApXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdHJpcHMgdGhlIHF1ZXJ5IGFuZCBmcmFnbWVudCBmcm9tIHRoZSBnaXZlbiB1cmlcbiAgICogQHBhcmFtIHVyaSBUaGUgdXJpIHRvIHJlbW92ZSB0aGUgcXVlcnkgYW5kIGZyYWdtZW50IGZyb21cbiAgICovXG4gIHByaXZhdGUgc3RyaXBRdWVyeUZyb20odXJpOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmICh1cmkuaW5kZXhPZignPycpID4gLTEpIHtcbiAgICAgIHVyaSA9IHVyaS5zdWJzdHIoMCwgdXJpLmluZGV4T2YoJz8nKSk7XG4gICAgfVxuXG4gICAgaWYgKHVyaS5pbmRleE9mKCcjJykgPiAtMSkge1xuICAgICAgdXJpID0gdXJpLnN1YnN0cigwLCB1cmkuaW5kZXhPZignIycpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdXJpO1xuICB9XG5cbiAgLyoqXG4gICAqIERldGVybWluZXMgd2hldGhlciB0aGUgc3BlY2lmaWVkIHJvdXRlIGNhbiBoYXZlIGFuIGFjY2VzcyB0b2tlbiBhdHRhY2hlZCB0byBpdCwgYmFzZWQgb24gbWF0Y2hpbmcgdGhlIEhUVFAgcmVxdWVzdCBhZ2FpbnN0XG4gICAqIHRoZSBpbnRlcmNlcHRvciByb3V0ZSBjb25maWd1cmF0aW9uLlxuICAgKiBAcGFyYW0gcm91dGUgVGhlIHJvdXRlIHRvIHRlc3RcbiAgICogQHBhcmFtIHJlcXVlc3QgVGhlIEhUVFAgcmVxdWVzdFxuICAgKi9cbiAgcHJpdmF0ZSBjYW5BdHRhY2hUb2tlbihcbiAgICByb3V0ZTogQXBpUm91dGVEZWZpbml0aW9uLFxuICAgIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT5cbiAgKTogYm9vbGVhbiB7XG4gICAgY29uc3QgdGVzdFByaW1pdGl2ZSA9ICh2YWx1ZTogc3RyaW5nIHwgdW5kZWZpbmVkKTogYm9vbGVhbiA9PiB7XG4gICAgICBpZiAoIXZhbHVlKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVxdWVzdFBhdGggPSB0aGlzLnN0cmlwUXVlcnlGcm9tKHJlcXVlc3QudXJsKTtcblxuICAgICAgaWYgKHZhbHVlID09PSByZXF1ZXN0UGF0aCkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgLy8gSWYgdGhlIFVSTCBlbmRzIHdpdGggYW4gYXN0ZXJpc2ssIG1hdGNoIHVzaW5nIHN0YXJ0c1dpdGguXG4gICAgICByZXR1cm4gKFxuICAgICAgICB2YWx1ZS5pbmRleE9mKCcqJykgPT09IHZhbHVlLmxlbmd0aCAtIDEgJiZcbiAgICAgICAgcmVxdWVzdC51cmwuc3RhcnRzV2l0aCh2YWx1ZS5zdWJzdHIoMCwgdmFsdWUubGVuZ3RoIC0gMSkpXG4gICAgICApO1xuICAgIH07XG5cbiAgICBpZiAoaXNIdHRwSW50ZXJjZXB0b3JSb3V0ZUNvbmZpZyhyb3V0ZSkpIHtcbiAgICAgIGlmIChyb3V0ZS5odHRwTWV0aG9kICYmIHJvdXRlLmh0dHBNZXRob2QgIT09IHJlcXVlc3QubWV0aG9kKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovXG4gICAgICBpZiAoIXJvdXRlLnVyaSAmJiAhcm91dGUudXJpTWF0Y2hlcikge1xuICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgJ0VpdGhlciBhIHVyaSBvciB1cmlNYXRjaGVyIGlzIHJlcXVpcmVkIHdoZW4gY29uZmlndXJpbmcgdGhlIEhUVFAgaW50ZXJjZXB0b3IuJ1xuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcm91dGUudXJpTWF0Y2hlclxuICAgICAgICA/IHJvdXRlLnVyaU1hdGNoZXIocmVxdWVzdC51cmwpXG4gICAgICAgIDogdGVzdFByaW1pdGl2ZShyb3V0ZS51cmkpO1xuICAgIH1cblxuICAgIHJldHVybiB0ZXN0UHJpbWl0aXZlKHJvdXRlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUcmllcyB0byBtYXRjaCBhIHJvdXRlIGZyb20gdGhlIFNESyBjb25maWd1cmF0aW9uIHRvIHRoZSBIVFRQIHJlcXVlc3QuXG4gICAqIElmIGEgbWF0Y2ggaXMgZm91bmQsIHRoZSByb3V0ZSBjb25maWd1cmF0aW9uIGlzIHJldHVybmVkLlxuICAgKiBAcGFyYW0gcmVxdWVzdCBUaGUgSHR0cCByZXF1ZXN0XG4gICAqIEBwYXJhbSBjb25maWcgSHR0cEludGVyY2VwdG9yQ29uZmlnXG4gICAqL1xuICBwcml2YXRlIGZpbmRNYXRjaGluZ1JvdXRlKFxuICAgIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4sXG4gICAgY29uZmlnOiBIdHRwSW50ZXJjZXB0b3JDb25maWdcbiAgKTogT2JzZXJ2YWJsZTxBcGlSb3V0ZURlZmluaXRpb24gfCBudWxsPiB7XG4gICAgcmV0dXJuIGZyb20oY29uZmlnLmFsbG93ZWRMaXN0KS5waXBlKFxuICAgICAgZmlyc3QoKHJvdXRlKSA9PiB0aGlzLmNhbkF0dGFjaFRva2VuKHJvdXRlLCByZXF1ZXN0KSwgbnVsbClcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBhbGxvd0Fub255bW91cyhyb3V0ZTogQXBpUm91dGVEZWZpbml0aW9uIHwgbnVsbCwgZXJyOiBhbnkpOiBib29sZWFuIHtcbiAgICByZXR1cm4gKFxuICAgICAgISFyb3V0ZSAmJlxuICAgICAgaXNIdHRwSW50ZXJjZXB0b3JSb3V0ZUNvbmZpZyhyb3V0ZSkgJiZcbiAgICAgICEhcm91dGUuYWxsb3dBbm9ueW1vdXMgJiZcbiAgICAgIFsnbG9naW5fcmVxdWlyZWQnLCAnY29uc2VudF9yZXF1aXJlZCddLmluY2x1ZGVzKGVyci5lcnJvcilcbiAgICApO1xuICB9XG59XG4iXX0=